{"version":3,"file":"PersistedObject.js","sourceRoot":"","sources":["../../../src/utils/PersistedObject.ts"],"names":[],"mappings":"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","sourcesContent":["// PersistedObjects save data outside of memory.\n//\n// When we load a persisted object, it's possible we call `set`\n// before we finish loading. To address we handle set in two ways:\n//\n// 1. Before load\n// We simply update currentValue in memory\n//\n// 2. After load\n// We update currentValue in memory and in storage\n//\n// Each PersistedObject provides it's own `onMerge`\n// function to handle the merge of data from storage and memory\n// on load\n\n// Uses `requestIdleCallback` if available, otherwise calls the\n// callback immediately\nfunction safeIdleCallback(cb, timeout: number) {\n  if (typeof requestIdleCallback === 'undefined') {\n    cb();\n  } else {\n    requestIdleCallback(cb, { timeout });\n  }\n}\n\nexport class PersistedObject<T> {\n  _subs = [];\n  _persister: Storage;\n  _key: string;\n  _onMerge: (fromStorage: T, inMemoryValue: T) => any;\n  _loadedCbs: Array<() => void>;\n  _isLoading: boolean;\n  currentValue: T;\n  serialize: (T) => any;\n  parse: (any) => T;\n  _saveThrottleMs: number;\n  _idleCallbackMaxWaitMs: number;\n  _pendingSaveCbs: Array<() => void>;\n  _version: number;\n  _nextSave: null | NodeJS.Timeout = null;\n\n  constructor(\n    persister: Storage,\n    key: string,\n    defaultValue: T,\n    onMerge: (fromStorage: T, inMemoryValue: T) => any,\n    serialize = (x: T): any => {\n      return x;\n    },\n    parse = (x: any): T => {\n      return x;\n    },\n    saveThrottleMs = 100,\n    idleCallbackMaxWaitMs = 1000,\n  ) {\n    this._persister = persister;\n    this._key = key;\n\n    this._onMerge = onMerge;\n\n    this._loadedCbs = [];\n    this._isLoading = true;\n    this.currentValue = defaultValue;\n    this.serialize = serialize;\n    this.parse = parse;\n    this._saveThrottleMs = saveThrottleMs;\n    this._pendingSaveCbs = [];\n    this._version = 0;\n    this._idleCallbackMaxWaitMs = idleCallbackMaxWaitMs;\n\n    this._load();\n  }\n\n  async _getFromStorage() {\n    try {\n      return this.parse(await this._persister.getItem(this._key));\n    } catch (e) {\n      console.error(`Unable to read from storage for key=${this._key}`, e);\n      return null;\n    }\n  }\n\n  async _load() {\n    const fromStorage = await this._getFromStorage();\n    this._isLoading = false;\n\n    this._onMerge(fromStorage, this.currentValue);\n    for (const cb of this._loadedCbs) {\n      cb();\n    }\n  }\n\n  async waitForLoaded(): Promise<void> {\n    if (!this._isLoading) {\n      return;\n    }\n    const loadedPromise = new Promise<void>((resolve) => {\n      this._loadedCbs.push(resolve);\n    });\n    await loadedPromise;\n  }\n\n  isLoading() {\n    return this._isLoading;\n  }\n\n  version() {\n    return this._version;\n  }\n\n  async waitForSync() {\n    if (!this._nextSave) {\n      return;\n    }\n    const syncedPromise = new Promise<void>((resolve) => {\n      this._pendingSaveCbs.push(resolve);\n    });\n    await syncedPromise;\n  }\n\n  _writeToStorage() {\n    this._persister.setItem(this._key, this.serialize(this.currentValue));\n    for (const cb of this._pendingSaveCbs) {\n      cb();\n    }\n    this._pendingSaveCbs.length = 0;\n  }\n\n  async flush() {\n    if (!this._nextSave) {\n      return;\n    }\n    clearTimeout(this._nextSave);\n    this._writeToStorage();\n  }\n\n  _enqueuePersist(cb) {\n    if (this._nextSave) {\n      if (cb) {\n        this._pendingSaveCbs.push(cb);\n      }\n      return;\n    }\n    this._nextSave = setTimeout(() => {\n      safeIdleCallback(() => {\n        this._nextSave = null;\n        this._writeToStorage();\n      }, this._idleCallbackMaxWaitMs);\n    }, this._saveThrottleMs);\n  }\n\n  set(f, cb) {\n    this._version++;\n    this.currentValue = f(this.currentValue);\n    if (this._isLoading) {\n      this._loadedCbs.push(() => this._enqueuePersist(cb));\n    } else {\n      this._enqueuePersist(cb);\n    }\n    for (const sub of this._subs) {\n      sub(this.currentValue);\n    }\n  }\n\n  subscribe(cb) {\n    this._subs.push(cb);\n    cb(this.currentValue);\n\n    return () => {\n      this._subs = this._subs.filter((x) => x !== cb);\n    };\n  }\n}\n"]}