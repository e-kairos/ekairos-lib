import { z } from "zod";

export type SandboxMetaData = z.infer<typeof Sandbox>;

export const Sandbox = z.object({
  id: z.string(),
  memory: z.number(),
  vcpus: z.number(),
  region: z.string(),
  runtime: z.string(),
  timeout: z.number(),
  status: z.enum(["pending", "running", "stopping", "stopped", "failed"]),
  requestedAt: z.number(),
  startedAt: z.number().optional(),
  requestedStopAt: z.number().optional(),
  stoppedAt: z.number().optional(),
  duration: z.number().optional(),
  createdAt: z.number(),
  cwd: z.string(),
  updatedAt: z.number(),
});

export type SandboxRouteData = z.infer<typeof SandboxRoute>;

export const SandboxRoute = z.object({
  url: z.string(),
  subdomain: z.string(),
  port: z.number(),
});

export const Pagination = z.object({
  /**
   * Amount of items in the current page.
   * @example 20
   */
  count: z.number(),
  /**
   * Timestamp that must be used to request the next page.
   * @example 1540095775951
   */
  next: z.number().nullable(),
  /**
   * Timestamp that must be used to request the previous page.
   * @example 1540095775951
   */
  prev: z.number().nullable(),
});

export type CommandData = z.infer<typeof Command>;

export const Command = z.object({
  id: z.string(),
  name: z.string(),
  args: z.array(z.string()),
  cwd: z.string(),
  sandboxId: z.string(),
  exitCode: z.number().nullable(),
  startedAt: z.number(),
});

const CommandFinished = Command.extend({
  exitCode: z.number(),
});

export const SandboxResponse = z.object({
  sandbox: Sandbox,
});

export const SandboxAndRoutesResponse = SandboxResponse.extend({
  routes: z.array(SandboxRoute),
});

export const CommandResponse = z.object({
  command: Command,
});

export const CommandFinishedResponse = z.object({
  command: CommandFinished,
});

export const EmptyResponse = z.object({});

export const LogLine = z.object({
  stream: z.enum(["stdout", "stderr"]),
  data: z.string(),
});

export const SandboxesResponse = z.object({
  sandboxes: z.array(Sandbox),
  pagination: Pagination,
});

export const ExtendTimeoutResponse = z.object({
  sandbox: Sandbox,
});
